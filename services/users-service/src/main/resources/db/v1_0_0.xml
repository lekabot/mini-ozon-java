<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
    http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

  <changeSet author="Ilya Lopatin" id="v1.0.0">
    <createTable tableName="users">
      <column name="id" type="uuid"><constraints primaryKey="true" nullable="false"/></column>
      <column name="external_id" type="uuid"/>
      <column name="email" type="varchar(320)"><constraints unique="true" nullable="false"/></column>
      <column name="username" type="varchar(64)"><constraints unique="true" nullable="true"/></column>
      <column name="full_name" type="varchar(255)"><constraints nullable="false"/></column>
      <column name="phone" type="varchar(16)"><constraints unique="true" nullable="true"/></column>
      <column name="status" type="varchar(16)"><constraints nullable="false"/></column>
      <column name="language" type="varchar(8)"/>
      <column name="timezone" type="varchar(64)"/>
      <column name="birth_date" type="date"/>
      <column name="avatar_url" type="varchar(1024)"/>
      <column name="attributes" type="jsonb"/>
      <column name="created_at" type="timestamptz" defaultValueComputed="current_timestamp"><constraints nullable="false"/></column>
      <column name="updated_at" type="timestamptz" defaultValueComputed="current_timestamp"><constraints nullable="false"/></column>
      <column name="version" type="bigint" defaultValueNumeric="0"/>
    </createTable>

    <createIndex tableName="users" indexName="ix_users_email"><column name="email"/></createIndex>
    <createIndex tableName="users" indexName="ix_users_username"><column name="username"/></createIndex>
    <createIndex tableName="users" indexName="ix_users_created_at_desc"><column name="created_at" descending="true"/></createIndex>

    <createTable tableName="user_roles">
      <column name="user_id" type="uuid">
        <constraints nullable="false" foreignKeyName="fk_user_roles_user"
                     referencedTableName="users" referencedColumnNames="id"
                     deleteCascade="true"/></column>
      <column name="role" type="varchar(32)"><constraints nullable="false"/></column>
    </createTable>

    <addPrimaryKey tableName="user_roles" columnNames="user_id, role" constraintName="pk_user_roles"/>

    <createIndex tableName="user_roles" indexName="ix_user_roles_user"><column name="user_id"/></createIndex>
  </changeSet>
</databaseChangeLog>
